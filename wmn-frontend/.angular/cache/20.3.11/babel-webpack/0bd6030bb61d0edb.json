{"ast":null,"code":"import { EventEmitter } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common\";\nfunction NodeListComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 2);\n    i0.ɵɵtext(1, \"No nodes yet (waiting for telemetry)\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction NodeListComponent_div_1_div_20_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 8)(1, \"pre\");\n    i0.ɵɵtext(2);\n    i0.ɵɵpipe(3, \"json\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const node_r2 = i0.ɵɵnextContext().$implicit;\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind1(3, 1, ctx_r2.nodes[node_r2.id]));\n  }\n}\nfunction NodeListComponent_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\")(1, \"div\", 3)(2, \"div\", 4)(3, \"div\")(4, \"strong\");\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"div\", 2);\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"div\", 2);\n    i0.ɵɵtext(9);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"div\", 2);\n    i0.ɵɵtext(11);\n    i0.ɵɵpipe(12, \"number\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(13, \"div\", 2);\n    i0.ɵɵtext(14);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(15, \"div\", 5)(16, \"button\", 6);\n    i0.ɵɵlistener(\"click\", function NodeListComponent_div_1_Template_button_click_16_listener() {\n      const node_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.selected = ctx_r2.selected === node_r2.id ? null : node_r2.id);\n    });\n    i0.ɵɵtext(17, \"Details\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(18, \"button\", 6);\n    i0.ɵɵlistener(\"click\", function NodeListComponent_div_1_Template_button_click_18_listener() {\n      const node_r2 = i0.ɵɵrestoreView(_r1).$implicit;\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.onSend(node_r2.id, node_r2.suggestedChannel || 6));\n    });\n    i0.ɵɵtext(19, \"Set Ch\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵtemplate(20, NodeListComponent_div_1_div_20_Template, 4, 3, \"div\", 7);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const node_r2 = ctx.$implicit;\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate(node_r2.id);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Last seen: \", node_r2.lastSeen || \"\\u2014\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"RSSI: \", node_r2.lastRssi ?? \"\\u2014\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Busy%: \", node_r2.channelBusy != null ? i0.ɵɵpipeBind2(12, 6, node_r2.channelBusy, \"1.2-2\") : \"\\u2014\");\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\"Clients: \", node_r2.clients ?? 0);\n    i0.ɵɵadvance(6);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.selected === node_r2.id);\n  }\n}\nexport let NodeListComponent = /*#__PURE__*/(() => {\n  var _staticBlock;\n  class NodeListComponent {\n    constructor() {\n      this.nodes = {};\n      this.sendCommand = new EventEmitter();\n      // expose Object to template so templates can call Object.keys(...)\n      this.Object = Object;\n      // derived list displayed in template (array of normalized node entries)\n      this.displayNodes = [];\n      // cache keys for cheap change detection\n      this._lastKeysJson = '';\n    }\n    ngDoCheck() {\n      const keys = this.nodes ? Object.keys(this.nodes) : [];\n      const json = JSON.stringify(keys);\n      if (json !== this._lastKeysJson) {\n        this._lastKeysJson = json;\n        this.rebuildDisplayNodes();\n        console.log('[NodeList] doCheck rebuilt displayNodes count=', this.displayNodes.length);\n      } else {\n        // minor defensive rebuild to keep numbers normalized if some children mutate in-place\n        this.rebuildDisplayNodes();\n      }\n    }\n    rebuildDisplayNodes() {\n      const out = [];\n      if (!this.nodes) {\n        this.displayNodes = [];\n        return;\n      }\n      for (const id of Object.keys(this.nodes)) {\n        const n = this.nodes[id] || {};\n        // normalize fields (coerce numeric values when possible)\n        const lastSeen = n.lastSeen ?? n.windowEnd ?? n.ts ?? n.last_seen ?? undefined;\n        const lastRssi = n.lastRssi != null ? Number(n.lastRssi) : n.avgRssi != null ? Number(n.avgRssi) : null;\n        const channelBusy = n.channelBusy != null ? Number(n.channelBusy) : n.avgChannelBusyPercent != null ? Number(n.avgChannelBusyPercent) : null;\n        const clients = n.clients != null ? Number(n.clients) : n.sampleCount != null ? Number(n.sampleCount) : null;\n        const suggestedChannel = n.suggestedChannel != null ? Number(n.suggestedChannel) : undefined;\n        const currentChannel = n.currentChannel != null ? Number(n.currentChannel) : undefined;\n        // Filter: include only if it looks like a real node telemetry entry (has lastSeen or channelBusy or clients)\n        const looksLikeNode = !!lastSeen || channelBusy !== null || clients !== null;\n        if (!looksLikeNode) {\n          // skip entries that appear to be non-node messages accidentally injected\n          continue;\n        }\n        out.push({\n          id,\n          lastSeen,\n          lastRssi,\n          channelBusy,\n          clients,\n          suggestedChannel,\n          currentChannel\n        });\n      }\n      // sort by lastSeen (newest first) if available\n      out.sort((a, b) => {\n        if (a.lastSeen && b.lastSeen) return new Date(b.lastSeen).getTime() - new Date(a.lastSeen).getTime();\n        if (a.lastSeen && !b.lastSeen) return -1;\n        if (!a.lastSeen && b.lastSeen) return 1;\n        return a.id.localeCompare(b.id);\n      });\n      this.displayNodes = out;\n    }\n    onSend(nodeId, channel) {\n      this.sendCommand.emit({\n        nodeId,\n        channel\n      });\n    }\n    static #_ = _staticBlock = () => (this.ɵfac = function NodeListComponent_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || NodeListComponent)();\n    }, this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: NodeListComponent,\n      selectors: [[\"app-node-list\"]],\n      inputs: {\n        nodes: \"nodes\"\n      },\n      outputs: {\n        sendCommand: \"sendCommand\"\n      },\n      decls: 2,\n      vars: 2,\n      consts: [[\"class\", \"small\", 4, \"ngIf\"], [4, \"ngFor\", \"ngForOf\"], [1, \"small\"], [1, \"list-item\"], [1, \"row\"], [1, \"actions\"], [1, \"button\", 3, \"click\"], [\"class\", \"small\", \"style\", \"margin-top:8px\", 4, \"ngIf\"], [1, \"small\", 2, \"margin-top\", \"8px\"]],\n      template: function NodeListComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵtemplate(0, NodeListComponent_div_0_Template, 2, 0, \"div\", 0)(1, NodeListComponent_div_1_Template, 21, 9, \"div\", 1);\n        }\n        if (rf & 2) {\n          i0.ɵɵproperty(\"ngIf\", !ctx.displayNodes || ctx.displayNodes.length === 0);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngForOf\", ctx.displayNodes);\n        }\n      },\n      dependencies: [CommonModule, i1.NgForOf, i1.NgIf, i1.JsonPipe, i1.DecimalPipe],\n      styles: [\".list-item[_ngcontent-%COMP%]{padding:8px;border-radius:8px;margin-bottom:8px;background:#ffffff05}.row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.actions[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px}.small[_ngcontent-%COMP%]{font-size:12px;color:#9fb0c8}.button[_ngcontent-%COMP%]{background:#2563eb;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}\"]\n    }));\n  }\n  _staticBlock();\n  return NodeListComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}